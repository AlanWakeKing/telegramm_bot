# Конспект проекта `telegramm_bot`

## Назначение
Telegram‑бот для продажи и выдачи VPN‑доступа с учетом баланса, ручной модерации оплат, реферальной программы и профиля пользователя. Реализован на `aiogram` + PostgreSQL (SQLAlchemy async). Интерфейс — один “экран” (бот редактирует одно сообщение вместо спама).

## Точки входа и запуск
- `app/main.py` — запуск бота, регистрация роутеров и middleware, установка команды `/start`.
- `app/config.py` — чтение `BOT_TOKEN`, `DATABASE_URL` через `pydantic-settings` (из `.env`).
- `Dockerfile`, `docker-compose.yml` — контейнеризация.

## Архитектура (высокоуровнево)
- `aiogram` роутеры обрабатывают сообщения и callback‑кнопки.
- Сессия пользователя хранится в `tg_sessions` (state + payload JSON).
- Основная логика хранения/чтения данных — `app/services/repo.py` (raw SQL через `text`).
- Выдача ключей сейчас заглушечная (`create_vpn_profile_stub`).
- UI “в один экран”: общая утилита `app/handlers/screen.py` редактирует одно сообщение.

## Основные модули

### `app/models.py`
SQLAlchemy модели:
- Базовые: `bot_settings`, `tg_users`, `tg_sessions`, `plans`, `payment_orders`, `payment_proofs`, `vpn_profiles`.
- Новые таблицы (после миграции): `promo_codes`, `promo_usages`, `referral_wallets`, `referral_pending`, `referral_withdrawals`, `support_tickets`, `support_messages`.

### `app/services/repo.py`
Слой БД (основные операции):
- Пользователь и сессия: `upsert_user`, `ensure_session`, `load_user_with_session`, `set_state_clear`, `set_state_payload`, `load_user_by_id`.
- Справочники: `list_servers`, `list_plans`, `load_plan`, `load_admin_ids`.
- Баланс: `get_balance`, `apply_balance_delta`.
- Платежи: `insert_payment_order`, `insert_payment_proof`, `load_payment_proof`, `update_order_status`, `load_order`, `load_payment_history`, `load_last_paid_order`.
- VPN профили: `create_vpn_profile_stub`, `list_active_profiles`, `update_profile_access_until`, `has_trial_used`.
- Настройки пользователя: `get_user_settings`, `set_notifications`.
- Логи: `log_event`.
- Рефералы: pending‑бонусы, кошелёк рефералов, заявки на вывод (новые таблицы).
- Поддержка: тикеты и сообщения поддержки (новые таблицы).
- Промокоды: `promo_codes` + `promo_usages` (новые таблицы).

### `app/handlers/screen.py`
- Унифицированная работа с “одним экраном”: `edit_screen`, `edit_screen_by_user`.

### `app/handlers/menu.py`
- Главное меню (inline‑кнопки) + `/start`.
- Переходы: профиль, оплата, подключение VPN, рефералы, промокод, поддержка.
- При открытии меню обрабатываются pending‑реф‑бонусы (переносятся в реф‑кошелёк).

### `app/handlers/buy.py`
Сценарий покупки VPN:
- Шаг 1: выбор протокола (VLESS/ShadowSocks/Outline/WireGuard).
- Шаг 2: выбор сервера (показывается загруженность).
- Шаг 3: выбор тарифа.
- Trial: проверка и выдача заглушечного ключа.
- Paid: списание баланса, выдача ключа, лог оплаты.

### `app/handlers/balance.py`
Баланс и продление:
- Меню оплаты, выбор метода и суммы пополнения.
- Оплата переводом через `t-qr.ru` с уникальным кодом платежа.
- Пополнение требует отправки чека/скрина.
- Продление: выбор активного ключа → выбор тарифа → списание баланса → продление `access_until`.

### `app/handlers/payment.py`
- Приём фото/документа оплаты.
- Создание `payment_order` и `payment_proof`.
- Уведомление админов с кнопками “Подтвердить/Отклонить”.
- При подтверждении: пополнение баланса или выдача ключа.
- Админское сообщение удаляется после принятия решения.
- Реферальный бонус добавляется в pending на 24 часа.

### `app/handlers/profile.py`
- Профиль: баланс, статус подписки, активные ключи, уведомления.
- История оплат с постраничной навигацией и открытием чека.
- Реферальный блок (в профиле и в “Пригласи друга”):
  - реф‑ссылка
  - условия вывода
  - количество рефералов
  - доступно на вывод (реф‑кошелёк)
  - кнопка “Отправить ссылку”
  - кнопка “Перевод на баланс” (если < 500 ₽ — кнопка “недоступна”)
- Заявка на вывод: уходит в админку, админ подтверждает/отклоняет.
- Обращения в поддержку: список тикетов пользователя, просмотр истории, открыть/закрыть, продолжение диалога.

### `app/handlers/config.py`
- Вывод конфигурации активного ключа (config URI). Если ключей несколько — направляет в “Профиль → Активные ключи”.

### `app/handlers/fallback.py`
- Заглушка “Инструкции”, обработка “назад в меню”, неизвестные сообщения.
- Поддержка: создание тикета, сообщения в админ‑группу, ответы админа, продолжение диалога.

## Реферальная программа (текущая логика)
- Реф‑ссылка: `/start refREF<ID>` или `ref<ID>`.
- Бонус: **10%** от суммы любого пополнения/оплаты реферала.
- Задержка начисления: **24 часа**.
- Бонус не сразу на баланс, а в **реф‑кошелёк**.
- Вывод в баланс по заявке (минимум **500 ₽**), админ подтверждает/отклоняет.
- Анти‑фрод: самореф запрещён, `referrer_id` фиксируется один раз, за один заказ бонус не дублируется.

## Промокоды
- Хранятся в `promo_codes`, факты использования — `promo_usages`.
- Бонус начисляется на баланс пользователя, проверяется срок и лимит.

## Поддержка (тикеты)
- Пользователь пишет через “Написать админу” → создаётся тикет (`support_tickets`).
- Сообщения сохраняются в `support_messages`.
- Админ отвечает из группы, пользователь видит ответы внутри обращения.

## UI “один экран”
- Бот редактирует одно сообщение в чате, чтобы не захламлять историю.
- Все основные сценарии используют `edit_screen`.

## Файлы окружения
- `.env.example` — пример переменных окружения (`BOT_TOKEN`, `DATABASE_URL`).
- `build_push.ps1` — сборка и пуш Docker‑образа (в `.gitignore`).

## Миграция из `bot_settings`
- Скрипт: `migrations/migrate_bot_settings_to_tables.sql` — переносит старые данные в новые таблицы.
- После миграции можно удалить старые ключи `bot_settings` (одноразовый SQL).

## Основной бизнес‑флоу
- `/start` → создание `tg_users` + `tg_sessions` → меню.
- Покупка: протокол → сервер → тариф → trial/paid.
- Пополнение: сумма → чек → админ подтверждает → баланс пополнен.
- Продление: ключ → тариф → списание → продление.
- Рефералы: бонус через 24ч → реф‑кошелёк → заявка → одобрение админом.

## Что важно учитывать
- Реальная интеграция с VPN‑провайдерами не реализована (пока заглушка).
- Оплаты ручные: чек → подтверждение админом.
- Реф‑вывод требует подтверждения админом.
