# –ö–æ–Ω—Å–ø–µ–∫—Ç –ø—Ä–æ–µ–∫—Ç–∞ `telegramm_n8n_bot`

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
Telegram‚Äë–±–æ—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –∏ –≤—ã–¥–∞—á–∏ VPN‚Äë–¥–æ—Å—Ç—É–ø–∞ —Å —É—á—ë—Ç–æ–º –±–∞–ª–∞–Ω—Å–∞, —Ä—É—á–Ω–æ–π –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –æ–ø–ª–∞—Ç, —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ `aiogram` + PostgreSQL (SQLAlchemy async). –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ç–∞–∫–∂–µ –ª–µ–∂–∏—Ç —Å—Ç–∞—Ä—ã–π/–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π workflow n8n (`GW.json`).

## –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –∏ –∑–∞–ø—É—Å–∫
- `app/main.py` ‚Äî –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤ –∏ middleware, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã `/start`.
- `app/config.py` ‚Äî —á—Ç–µ–Ω–∏–µ `BOT_TOKEN`, `DATABASE_URL` —á–µ—Ä–µ–∑ `pydantic-settings` (–∏–∑ `.env`).
- `Dockerfile`, `docker-compose.yml` ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è (–æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å `bot`).

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ)
- `aiogram` —Ä–æ—É—Ç–µ—Ä—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ callback‚Äë–∫–Ω–æ–ø–∫–∏.
- –°–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `tg_sessions` (state + payload JSON).
- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è/—á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ `app/services/repo.py` —á–µ—Ä–µ–∑ SQL‚Äë–∑–∞–ø—Ä–æ—Å—ã (text SQL).
- –í—ã–¥–∞—á–∞ VPN‚Äë–∫–ª—é—á–µ–π —Å–µ–π—á–∞—Å –∑–∞–≥–ª—É—à–µ—á–Ω–∞—è (`create_vpn_profile_stub` –≥–µ–Ω–µ—Ä–∏—Ç `config_uri`).

## –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏

### `app/models.py`
SQLAlchemy –º–æ–¥–µ–ª–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã):
- `bot_settings`, `tg_users`, `tg_sessions`, `plans`, `payment_orders`, `payment_proofs`, `vpn_profiles`.
- –ü–æ–ª—è `config_uri`, `provider_meta`, `status` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –≤—ã–¥–∞—á–∏ –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.

### `app/services/repo.py`
–°–ª–æ–π –ë–î (–æ—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏):
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ —Å–µ—Å—Å–∏—è: `upsert_user`, `ensure_session`, `load_user_with_session`, `set_state_clear`, `set_state_payload`.
- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏: `list_servers`, `list_plans`, `load_plan`, `load_admin_ids`.
- –ë–∞–ª–∞–Ω—Å: `get_balance`, `apply_balance_delta`.
- –ü–ª–∞—Ç–µ–∂–∏: `insert_payment_order`, `insert_payment_proof`, `load_payment_proof`, `update_order_status`, `load_order`, `load_payment_history`, `load_last_paid_order`.
- VPN –ø—Ä–æ—Ñ–∏–ª–∏: `create_vpn_profile_stub`, `list_active_profiles`, `update_profile_access_until`, `has_trial_used`.
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: `get_user_settings`, `set_notifications`.
- –õ–æ–≥–∏: `log_event`.

### `app/handlers/menu.py`
- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (inline‚Äë–∫–Ω–æ–ø–∫–∏) –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ `/start` –∏ ‚Äúüè† –ú–µ–Ω—é‚Äù.
- –õ–æ–≥–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏, –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –ø—Ä–æ—Ñ–∏–ª—å, –æ–ø–ª–∞—Ç—É, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN.

### `app/handlers/buy.py`
–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–∫—É–ø–∫–∏ VPN:
- –®–∞–≥ 1: –≤—ã–±–æ—Ä –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (VLESS/ShadowSocks/Outline/WireGuard).
- –®–∞–≥ 2: –≤—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ–∫–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏).
- –®–∞–≥ 3: –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞.
- Trial: –ø—Ä–æ–≤–µ—Ä–∫–∞, –≤—ã–¥–∞—á–∞ –∑–∞–≥–ª—É—à–µ—á–Ω–æ–≥–æ –∫–ª—é—á–∞ + –ª–æ–≥.
- Paid: —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, –≤—ã–¥–∞—á–∞ –∫–ª—é—á–∞, –ª–æ–≥ –æ–ø–ª–∞—Ç—ã.

### `app/handlers/balance.py`
–ë–∞–ª–∞–Ω—Å –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ:
- –ú–µ–Ω—é –æ–ø–ª–∞—Ç—ã, –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –∏ —Å—É–º–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.
- –í–∞—Ä–∏–∞–Ω—Ç –æ–ø–ª–∞—Ç—ã ‚Äî –ø–µ—Ä–µ–≤–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ `t-qr.ru` (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∑–∞–≥–ª—É—à–∫–∏).
- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞/—Å–∫—Ä–∏–Ω–∞.
- –ü—Ä–æ–¥–ª–µ–Ω–∏–µ: –≤—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª—é—á–∞, –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞, —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, –ø—Ä–æ–¥–ª–µ–Ω–∏–µ `access_until`.

### `app/handlers/payment.py`
- –ü—Ä–∏—ë–º —Ñ–æ—Ç–æ/–¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ–ø–ª–∞—Ç—ã.
- –°–æ–∑–¥–∞–Ω–∏–µ `payment_order` –∏ `payment_proof`.
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏ ‚Äú–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å‚Äù.
- –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏: –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ª–∏–±–æ –≤—ã–¥–∞—á–∞ –∫–ª—é—á–∞.

### `app/handlers/profile.py`
- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –±–∞–ª–∞–Ω—Å, —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏, –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
- –ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç —Å –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π.
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞.

### `app/handlers/config.py`
- –í—ã–≤–æ–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π (config URI) —Å —á–∞–Ω–∫–∞–º–∏ –ø–æ –ª–∏–º–∏—Ç—É Telegram.

### `app/handlers/fallback.py`
- –ó–∞–≥–ª—É—à–∫–∏ ‚Äú–ø–æ–º–æ—â—å‚Äù, ‚Äú–Ω–∞–∑–∞–¥ –≤ –º–µ–Ω—é‚Äù, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

## –§–∞–π–ª—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `.env.example` ‚Äî –ø—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∏—Ç `BOT_TOKEN` –∏ `DATABASE_URL` (—Å–µ–π—á–∞—Å —Ç–∞–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —ç—Ç–æ —Ä–∏—Å–∫ —É—Ç–µ—á–∫–∏).

## –û—Å–Ω–æ–≤–Ω–æ–π –±–∏–∑–Ω–µ—Å‚Äë—Ñ–ª–æ—É
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí `/start` ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ `tg_users` + `tg_sessions` ‚Üí –º–µ–Ω—é.
- –ü–æ–∫—É–ø–∫–∞: –≤—ã–±–æ—Ä –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ ‚Üí —Å–µ—Ä–≤–µ—Ä ‚Üí —Ç–∞—Ä–∏—Ñ ‚Üí
  - trial: –ø—Ä–æ–≤–µ—Ä–∫–∞, –≤—ã–¥–∞—á–∞ –∑–∞–≥–ª—É—à–∫–∏.
  - paid: –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞, —Å–ø–∏—Å–∞–Ω–∏–µ, –≤—ã–¥–∞—á–∞ –∑–∞–≥–ª—É—à–∫–∏.
- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: –≤—ã–±–æ—Ä —Å—É–º–º—ã ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ–∫–∞ ‚Üí admin –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω.
- –ü—Ä–æ–¥–ª–µ–Ω–∏–µ: –≤—ã–±–æ—Ä –∫–ª—é—á–∞ ‚Üí –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ ‚Üí —Å–ø–∏—Å–∞–Ω–∏–µ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `access_until`.

## –ß—Ç–æ –≤–∞–∂–Ω–æ —É—á–µ—Å—Ç—å
- –í—ã–¥–∞—á–∞ –∫–ª—é—á–∞ –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–µ—á–Ω–∞—è (`create_vpn_profile_stub`), –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –Ω–µ—Ç.
- –ë–∞–ª–∞–Ω—Å –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ —Ä—É—á–Ω—É—é –º–æ–¥–µ—Ä–∞—Ü–∏—é –æ–ø–ª–∞—Ç.
- –í `.env.example` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ URL –ë–î ‚Äî –∏—Ö –ª—É—á—à–µ —É–¥–∞–ª–∏—Ç—å/–∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ñ–µ–π–∫–æ–≤—ã–µ.
- –í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –∏ Python‚Äë–±–æ—Ç, –∏ n8n‚Äëworkflow ‚Äî –Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å, –∫–∞–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–∞—è.
